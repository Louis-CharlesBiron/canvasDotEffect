const ACCEPTABLE_DIF=1e-7;function random(min,max,decimals=0){return+(Math.random()*(max-min)+min).toFixed(decimals)}class FPSCounter{constructor(avgSampleSize){this._t=[],this._maxFps=0,this._avgSampleSize=avgSampleSize||10,this._avg=[]}getFpsRaw(){let fps,n=performance.now();for(;this._t.length>0&&this._t[0]<=n-1e3;)this._t.shift();return fps=this._t.push(n),this._maxFps<fps&&(this._maxFps=fps),fps}getFps(){return this._avg.push(this.getFpsRaw()),this._avg.length>this._avgSampleSize&&this._avg.shift(),Math.floor(Math.min(this._avg.reduce(((a,b)=>a+b),0)/this._avgSampleSize,this._maxFps))}get maxFps(){return this._maxFps-1}get avgSample(){return this._avgSampleSize}get fpsRaw(){return this._t.length}set avgSample(s){this._avgSampleSize=s}}function getDist(x1,y1,x2,y2){return Math.sqrt((x1-x2)**2+(y1-y2)**2)}function mod(max,ratio,range){return range??=max,max-ratio*range+max*((range>=0)-1)}function formatColor(rgba){return"object"==typeof rgba?`rgba(${rgba[0]}, ${rgba[1]}, ${rgba[2]}, ${rgba[3]})`:rgba}function toRad(deg){return deg*(Math.PI/180)}function toDeg(rad){return rad/(Math.PI/180)}function getAcceptableDif(n,okDif){return Math.round(n)-n<=okDif?Math.round(n):n}function getMinMax(arr,propPath=null){let min=1/0,max=-1/0,ll=arr.length;for(let i=0;i<ll;i++){let v=propPath?+arr[i][propPath]:arr[i];v<min&&(min=v),v>max&&(max=v)}return[min,max]}function repeatedTimeout(iterationCount,callback,delay=5){let at=0;for(let i=0;i<iterationCount;i++)setTimeout((()=>callback(i)),at+=delay)}Array.prototype.last=function(index=0){return this[this.length-1-index]},Array.prototype.addAt=function(el,index=0){return this.slice(0,index).concat(el,this.slice(index,this.length))};const SHOW_CENTERS_DOT_ID={};function toggleCenter(shape,radius=5,color=[255,0,0,1]){if(SHOW_CENTERS_DOT_ID[shape.id])CVS.remove(SHOW_CENTERS_DOT_ID[shape.id]),SHOW_CENTERS_DOT_ID[shape.id]=void 0;else{let dot=new Dot((()=>[shape.x,shape.y]),radius,color);SHOW_CENTERS_DOT_ID[shape.id]=dot.id,CVS.add(dot,!0)}}class CvsUtils{static drawDotConnections(dot,rgba=[255,255,255,1],isSourceOver=!1){let ctx=dot.ctx,dc_ll=dot.connections.length;if(isSourceOver||(ctx.globalCompositeOperation="destination-over"),dc_ll)for(let i=0;i<dc_ll;i++){let c=dot.connections[i];ctx.strokeStyle=formatColor(rgba),ctx.beginPath(),ctx.moveTo(dot.x,dot.y),ctx.lineTo(c.x,c.y),ctx.stroke()}isSourceOver||(ctx.globalCompositeOperation="source-over")}static drawOuterRing(dot,rgba=[255,255,255,1],radiusMultiplier){let ctx=dot.ctx;ctx.strokeStyle=formatColor(rgba),ctx.beginPath(),ctx.arc(dot.x,dot.y,dot.radius*radiusMultiplier,0,CIRC),ctx.stroke()}static drawConnections(dot,rgba=[255,255,255,1],sourcePos){let ctx=dot.ctx;ctx.strokeStyle=formatColor(rgba),ctx.beginPath(),ctx.moveTo(sourcePos[0],sourcePos[1]),ctx.lineTo(dot.x,dot.y),ctx.stroke()}static getDraggableDotCB(pickableRadius=50){let mouseup=!1,adotShapeAnim=null;return(dot,mouse,dist,ratio)=>{mouse.clicked&&dist<pickableRadius?(mouseup=!0,dot?.currentAnim?.id==adotShapeAnim?.id&&adotShapeAnim&&adotShapeAnim.end(),dot.x=mouse.x,dot.y=mouse.y):mouseup&&(mouseup=!1,adotShapeAnim=dot.addForce(Math.min(mod(Math.min(mouse.speed,3e3),ratio)/4,300),mouse.dir,750+1200*ratio,Anim.easeOutQuad))}}}class GridAssets{static D=[["t","-ar"],["r",1],["b","ar"],["l",-1],["tr","1-ar"],["br","ar+1"],["bl","ar-1"],["tl","-ar-1"]].reduce(((a,[b,d],i)=>(a.places.push([a[b]=1<<i,ar=>new Function("ar",`return ${d}`)(ar)]),a)),{places:[]});static get fontSource5x5(){const D=GridAssets.D;return{width:5,height:5,A:[[2,D.bl+D.br],[1,D.bl],[3,D.br],[0,D.r+D.b],[1,D.r],[2,D.r],[3,D.r],[4,D.b],[0,D.b],[4,D.b],[0],[4]],B:[[0,D.r+D.b],[,D.r],[,D.r],[,D.br],[0,D.b],[4,D.bl],[0,D.r+D.b],[,D.r],[,D.r],[,D.br],[0,D.b],[4,D.bl],[0,D.r],[,D.r],[,D.r],[]],C:[[1,D.r+D.bl],[,D.r],[,D.r],[],[0,D.b],[0,D.b],[0,D.br],[-1,D.r],[2,D.r],[,D.r],[]],D:[[0,D.r+D.b],[,D.r],[,D.r],[,D.br],[0,D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.b],[4,D.bl],[0,D.r],[,D.r],[,D.r],[]],E:[[0,D.r+D.b],[,D.r],[,D.r],[,D.r],[],[0,D.b],[0,D.b+D.r],[,D.r],[,D.r],[,D.r],[0,D.b],[0,D.r],[,D.r],[,D.r],[,D.r],[]],F:[[0,D.r+D.b],[,D.r],[,D.r],[,D.r],[],[0,D.b],[0,D.b+D.r],[,D.r],[,D.r],[],[0,D.b],[0]],G:[[1,D.r+D.bl],[,D.r],[,D.r],[],[0,D.b],[0,D.b],[3,D.r],[4,D.b],[0,D.br],[4,D.b],[1,D.r],[,D.r],[,D.r],[]],H:[[0,D.r+D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.b+D.r],[,D.r],[,D.r],[,D.r],[,D.b],[0,D.b],[4,D.b],[0],[4]],I:[[1,D.r],[,D.b+D.r],[],[2,D.b],[2,D.b],[2,D.b],[1,D.r],[,D.r],[]],J:[[1,D.r],[,D.r],[,D.b+D.r],[],[3,D.b],[3,D.b],[0,D.br],[3,D.bl],[1,D.r],[,D.r]],K:[[0,D.b],[3,D.bl],[0,D.b],[2,D.bl],[0,D.b+D.r],[,D.r+D.br],[0,D.b],[2,D.br],[0],[3,D.r]],L:[[0,D.b],[0,D.b],[0,D.b],[0,D.b],[0,D.r],[,D.r],[,D.r],[,D.r]],M:[[0,D.b+D.br],[4,D.b+D.bl],[0,D.b],[,D.br],[3,D.bl],[4,D.b],[0,D.b],[2],[4,D.b],[0,D.b],[4,D.b],[0],[4]],N:[[0,D.b+D.br],[4,D.b],[0,D.b],[,D.br],[4,D.b],[0,D.b],[2,D.br],[4,D.b],[0,D.b],[3,D.br],[4,D.b],[0],[4]],O:[[1,D.bl+D.r],[,D.r],[,D.br],[0,D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.b+D.br],[4,D.b+D.bl],[1,D.r],[,D.r],[,D.r]],P:[[0,D.r+D.b],[,D.r],[,D.br],[0,D.b],[3,D.bl],[0,D.b+D.r],[,D.r],[],[0,D.b],[0]],Q:[[1,D.bl+D.r],[,D.r],[,D.br],[0,D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.b+D.br],[3,D.br],[,D.bl],[1,D.r],[,D.r],[],[]],R:[[0,D.r+D.b],[,D.r],[,D.br],[0,D.b],[3,D.bl],[0,D.b+D.r],[,D.r+D.br],[],[0,D.b],[2,D.br],[0],[3]],S:[[1,D.r+D.bl],[,D.r],[,D.r],[],[0,D.br],[-1,D.r],[2,D.r],[,D.br],[-4,D.bl],[0,D.r+D.bl],[,D.r],[,D.r],[]],T:[[0,D.r],[,D.r],[,D.b+D.r],[,D.r],[],[2,D.b],[2,D.b],[2,D.b],[2]],U:[[0,D.r+D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.b+D.r],[4,D.b],[0,D.br],[4,D.bl],[1,D.r],[,D.r],[,D.r]],V:[[0,D.r+D.b],[4,D.b],[0,D.b],[4,D.b],[0,D.br],[4,D.bl],[1,D.br],[3,D.bl],[2,D.r]],W:[[0,D.b+D.br],[4,D.b+D.bl],[0,D.b],[4,D.b],[0,D.b],[2,D.bl+D.br],[4,D.b],[0,D.b],[,D.bl],[3,D.br],[4,D.b],[0],[4]],X:[[0,D.br],[4,D.bl],[1,D.br],[3,D.bl],[2,D.br+D.bl],[1,D.bl],[3,D.br],[0],[4]],Y:[[0,D.br],[4,D.bl],[1,D.br],[3,D.bl],[2,D.b],[2,D.b],[2]],Z:[[0,D.r],[,D.r],[,D.r],[,D.r],[,D.bl],[3,D.bl],[2,D.bl],[1,D.bl],[0,D.r],[,D.r],[,D.r],[,D.r],[]]}}}const DEFAULT_MOUSE_DECELERATION=.8,DEFAULT_MOUSE_MOVE_TRESHOLD=.1,DEFAULT_MOUSE_ANGULAR_DECELERATION=.2;class Mouse{constructor(){this._valid=!1,this._x=null,this._y=null,this._lastX=null,this._lastY=null,this._dir=null,this._speed=null,this._clicked=!1,this._rightClicked=!1,this._scrollClicked=!1,this._extraForwardClicked=!1,this._extraBackClicked=!1}calcSpeed(deltaTime){isFinite(this._lastX)&&isFinite(this._lastY)&&deltaTime?(this._speed=.8*this._speed+getDist(this._x,this._y,this._lastX,this._lastY)/deltaTime*(1-.8),this._speed<.1&&(this._speed=0)):this._speed=0,this._lastX=this._x,this._lastY=this._y}calcAngle(){let dx=this._x-this._lastX,dy=this._y-this._lastY;if(isFinite(dx)&&isFinite(dy)&&(dx||dy)){let diff=(360-toDeg(Math.atan2(dy,dx)))%360-this._dir;diff+=360*(diff<-180)-360*(diff>180),this._dir=(this._dir+.2*diff+360)%360}else this._dir=0}setMouseClicks(e){let v="mousedown"==e.type;0==e.button?this._clicked=v:1==e.button?this._scrollClicked=v:2==e.button?this._rightClicked=v:3==e.button?this._extraBackClicked=v:4==e.button&&(this._extraForwardClicked=v)}invalidate(){this._x=1/0,this._y=1/0}updatePos(e,offset){this._valid=!0,this._x=e.x-offset.x,this._y=e.y-offset.y}checkValid(){return this._x==1/0||null==this._x||this._y==1/0||null==this._y?this._valid=!1:this._valid?void 0:this._valid=!0}get valid(){return this._valid}get x(){return this._x}get y(){return this._y}get lastX(){return this._lastX}get lastY(){return this._lastY}get dir(){return this._dir}get speed(){return this._speed}get clicked(){return this._clicked}get scrollClicked(){return this._scrollClicked}get rightClicked(){return this._rightClicked}get extraBackClicked(){return this._extraBackClicked}get extraForwardClicked(){return this._extraForwardClicked}get pos(){return[this._x,this._y]}set valid(valid){return this._valid=valid}set lastX(_lastX){return this._lastX=_lastX}set lastY(_lastY){return this._lastY=_lastY}set dir(_dir){return this._dir=_dir}set speed(_speed){return this._speed=_speed}set clicked(_clicked){return this._clicked=_clicked}set scrollClicked(_scrollClicked){return this._scrollClicked=_scrollClicked}set rightClicked(_rightClicked){return this._rightClicked=_rightClicked}set extraBackClicked(_extraBackClicked){return this._extraBackClicked=_extraBackClicked}set extraForwardClicked(_extraForwardClicked){return this._extraForwardClicked=_extraForwardClicked}}const DEFAULT_MAX_DELTATIME=.13,CANVAS_ACTIVE_AREA_PADDING=20,DEFAULT_LIMIT=100,DEFAULT_CVSDE_ATTR="_CVSDE",DEFAULT_CVSFRAMEDE_ATTR="_CVSDE_F",DEFAULT_CTX_SETTINGS={lineCap:"round",imageSmoothingEnabled:!1,lineWidth:2,fillStyle:"aliceblue",stokeStyle:"aliceblue"},TIMEOUT_FN=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,CIRC=2*Math.PI,DEFAULT_COLOR="aliceblue",DEFAULT_RGBA=[255,255,255,1],DEFAULT_POS=[0,0],DEFAULT_RADIUS=5,DEFAULT_CANVAS_WIDTH=800,DEFAULT_CANVAS_HEIGHT=800,DEFAULT_CANVAS_STYLES={position:"absolute",width:"100%",height:"100%","background-color":"transparent",border:"none",outline:"none","pointer-events":"none !important","z-index":0,padding:"0 !important",margin:"0"};let idGiver=0;class Canvas{#lastFrame=0;#deltaTimeCap=.13;#frameSkipsOffset=null;#timeStamp=null;constructor(cvs,loopingCallback,frame,settings=DEFAULT_CTX_SETTINGS){this._cvs=cvs,this._frame=frame??cvs?.parentElement,this._cvs.setAttribute("_CVSDE",!0),this._frame.setAttribute("_CVSDE_F",!0),this._ctx=this._cvs.getContext("2d"),this._settings=this.updateSettings(settings),this._els={refs:[],defs:[]},this._looping=!1,this._cb=loopingCallback,this._deltaTime=null,this._fixedTimeStamp=null,this._windowListeners=this.#initWindowListeners();let frameCBR=this._frame?.getBoundingClientRect()??{width:800,height:800};this.setSize(frameCBR.width,frameCBR.height),this.#initStyles(),this._mouse=new Mouse,this._offset=this.updateOffset()}#initStyles(){let style=document.createElement("style");style.appendChild(document.createTextNode(`[_CVSDE_F]{position:relative !important;}canvas[_CVSDE]{${Object.entries(DEFAULT_CANVAS_STYLES).reduce(((a,b)=>a+`${b[0]}:${b[1]};`),"")}}`)),this._cvs.appendChild(style)}#initWindowListeners(){const onresize=()=>{this.setSize()},onvisibilitychange=()=>{document.hidden||this.reset()};return window.addEventListener("resize",onresize),window.addEventListener("visibilitychange",onvisibilitychange),[()=>window.removeEventListener("resize",onresize),()=>window.removeEventListener("visibilitychange",onvisibilitychange)]}updateOffset(){let{width:width,height:height,x:x,y:y}=this._cvs.getBoundingClientRect();return this._offset={x:Math.round(x+width-this.width+window.scrollX),y:Math.round(y+height-this.height+window.scrollY)}}startLoop(){this._looping||(this._looping=!0,this.#loop(0))}#loop(time){let delay=Math.abs(time-this.#timeStamp-1e3*this.deltaTime);0==this._fixedTimeStamp&&(this._fixedTimeStamp=time-this.#frameSkipsOffset),time&&this._fixedTimeStamp&&delay<130?(this._mouse.calcSpeed(this._deltaTime),this.clear(),this.draw(),"function"==typeof this._cb&&this._cb(),this._fixedTimeStamp=0):time&&(this._fixedTimeStamp=time-(this.#frameSkipsOffset+=130),this.#frameSkipsOffset+=130),this.#timeStamp=time,this.#calcDeltaTime(time),this._looping&&TIMEOUT_FN(this.#loop.bind(this))}stopLoop(){this._looping=!1}#calcDeltaTime(time=0){this._deltaTime=Math.min((time-this.#lastFrame)/1e3,this.#deltaTimeCap),this.#lastFrame=time}draw(){let els=this._els.defs.concat(this.refs).concat(this._els.refs.flatMap((source=>source.asSource))),els_ll=els.length;for(let i=0;i<els_ll;i++){const el=els[i];el.draw&&this.isWithin(el.pos,20)&&el.draw(this._ctx,this.timeStamp,this._deltaTime)}}clear(x=0,y=0,width,height){this._ctx.clearRect(x??0,y??0,width??this._cvs.width,height??this._cvs.height)}reset(){this.refs.filter((source=>source.fragile)).forEach((r=>r.reset()))}setSize(w,h){let{width:width,height:height}=this._frame.getBoundingClientRect();null!==w&&(this._cvs.width=w??width),null!==h&&(this._cvs.height=h??height),this.updateSettings(),this.updateOffset()}updateSettings(settings){let st=settings||this._settings;return Object.entries(st).forEach((s=>this._ctx[s[0]]=s[1])),this._settings=st}add(objs,isDef){let l=objs.length??1;for(let i=0;i<l;i++){let obj=objs[i]??objs;isDef?(obj.parent=this,"function"==typeof obj.initialize&&obj.initialize()):(obj.cvs=this,"function"==typeof obj.initialize&&obj.initialize()),this._els[isDef?"defs":"refs"].push(obj)}}remove(id){this._els.defs=this._els.defs.filter((el=>el.id!==id)),this._els.refs=this._els.refs.filter((source=>source.id!==id))}get(id){return this.allEls.find((el=>el.id==id))}getObjs(instance){return this._els.defs.filter((x=>x instanceof instance))}#mouseMovements(cb,e){let r_ll=this.refs.length;for(let i=0;i<r_ll;i++){let ref=this.refs[i];void 0===ref.ratioPosCB&&(ref.ratioPos=this._mouse.pos)}"function"==typeof cb&&cb(this._mouse,e),this._mouse.checkValid()}setmousemove(cb){const onmousemove=e=>{this._mouse.updatePos(e,this._offset),this._mouse.calcAngle(),this.#mouseMovements(cb,e)};return this._frame.addEventListener("mousemove",onmousemove),()=>this._frame.removeEventListener("mousemove",onmousemove)}setmouseleave(cb){const onmouseleave=e=>{this._mouse.invalidate(),this.#mouseMovements(cb,e)};return this._frame.addEventListener("mouseleave",onmouseleave),()=>this._frame.removeEventListener("mouseleave",onmouseleave)}#mouseClicks(cb,e){this._mouse.setMouseClicks(e),"function"==typeof cb&&cb(this._mouse,e)}setmousedown(cb){const onmousedown=e=>this.#mouseClicks(cb,e);return this._frame.addEventListener("mousedown",onmousedown),()=>this._frame.removeEventListener("mousedown",onmousedown)}setmouseup(cb){const onmouseup=e=>this.#mouseClicks(cb,e);return this._frame.addEventListener("mouseup",onmouseup),()=>this._frame.removeEventListener("mouseup",onmouseup)}getCenter(){return[this.width/2,this.height/2]}isWithin(pos,padding=0){let[x,y]=pos;return x>=-padding&&x<=this.width+padding&&y>=-padding&&y<=this.height+padding}get cvs(){return this._cvs}get frame(){return this._frame}get ctx(){return this._ctx}get width(){return this._cvs.width}get height(){return this._cvs.height}get settings(){return this._settings}get cb(){return this._cb}get looping(){return this._looping}get deltaTime(){return this._deltaTime}get deltaTimeCap(){return this.#deltaTimeCap}get windowListeners(){return this._windowListeners}get timeStamp(){return this._fixedTimeStamp||this.#timeStamp}get timeStampRaw(){return this.#timeStamp}get els(){return this._els}get mouse(){return this._mouse}get offset(){return this._offset}get defs(){return this._els.defs}get refs(){return this._els.refs}get allDefsAndRefs(){return this.defs.concat(this.refs)}get allEls(){return this.allDefsAndRefs.flatMap((x=>x.dots||x))}set cb(_cb){return this._cb=_cb}set width(w){this.setSize(w,null)}set height(h){this.setSize(null,h)}}let animIdGiver=0;class Anim{constructor(animation,duration,easing,endCallback){this._id=animIdGiver++,this._animation=animation,this._duration=duration??1e3,this._easing=easing||(x=>x),this._endCallback=endCallback,this._startTime=null,this._progress=0,this._playCount=0}getFrame(time){let isInfinite=-1==Math.sign(this._duration);this._playCount&&!isInfinite||(this._startTime?time<this._startTime+Math.abs(this._duration)?this._animation(this._progress=this._easing((time-this._startTime)/Math.abs(this._duration)),this._playCount):isInfinite?this.reset(!0):this.end():this._startTime=time)}end(){this._animation(1,++this._playCount),"function"==typeof this._endCallback&&this._endCallback()}reset(isInfiniteReset){isInfiniteReset?this._animation(1,++this._playCount):this._playCount=0,this._progress=0,this._startTime=null}get id(){return this._id}get animation(){return this._animation}get duration(){return this._duration}get easing(){return this._easing}get endCallback(){return this._endCallback}get startTime(){return this._startTime}get progress(){return this._progress}get playCount(){return this._playCount}set animation(_animation){return this._animation=_animation}set duration(_duration){return this._duration=_duration}set easing(_easing){return this._easing=_easing}set endCallback(_endCallback){return this._endCallback=_endCallback}static get easeInOutQuad(){return x=>x<.5?2*x*x:1-Math.pow(-2*x+2,2)/2}static get easeOutQuad(){return x=>1-(1-x)*(1-x)}static get easeOutBounce(){return x=>x<1/2.75?7.5625*x*x:x<2/2.75?7.5625*(x-=1.5/2.75)*x+.75:x<2.5/2.75?7.5625*(x-=2.25/2.75)*x+.9375:7.5625*(x-=2.625/2.75)*x+.984375}static get easeInOutBounce(){return x=>x<.5?(1-this.easeOutBounce(1-2*x))/2:(1+this.easeOutBounce(2*x-1))/2}static get easeInOutBack(){return x=>x<.5?Math.pow(2*x,2)*(7.189819*x-2.5949095)/2:(Math.pow(2*x-2,2)*(3.5949095*(2*x-2)+2.5949095)+2)/2}static get easeInOutElastic(){return x=>0===x?0:1===x?1:x<.5?-Math.pow(2,20*x-10)*Math.sin((20*x-11.125)*(2*Math.PI)/4.5)/2:Math.pow(2,-20*x+10)*Math.sin((20*x-11.125)*(2*Math.PI)/4.5)/2+1}static get linear(){return x=>x}}class Obj{constructor(pos,radius,rgba,setupCB){this._id=idGiver++,this._initPos=pos||DEFAULT_POS,this._pos=this._initPos,this._radius=radius??5,this._rgba=rgba||DEFAULT_RGBA,this._setupCB=setupCB,this._anims=[]}initialize(){"function"==typeof this._initPos&&(this._pos=this._initPos(this._cvs,this?.parent??this?.dots)),"function"==typeof this._setupCB&&this._setupCB(this,this?.parent)}draw(ctx,time){this._anims[0]&&this._anims[0].getFrame(time)}isWithin(pos,circularDetection){let[x,y]=pos;return circularDetection?getDist(x,y,this.x,this.y)<=this.radius*(1==+circularDetection?1.025:+circularDetection):x>=this.left&&x<=this.right&&y>=this.top&&y<=this.bottom}posDistances(pos=this._pos){let[x,y]=pos,cw=this._cvs.width,ch=this._cvs.height;return[y-this.height/2,cw-(x+this.width/2),ch-(y+this.height/2),x-this.width/2]}moveAt(pos){let[x,y]=pos;null!=x&&(this.x=x),null!=y&&(this.y=y)}moveBy(pos){let[x,y]=pos;null!=x&&(this.x+=x),null!=y&&(this.y+=y)}moveTo(pos,time=1e3,easing=Anim.easeInOutQuad,force=!0,initPos=[this.x,this.y]){let[ix,iy]=initPos,[fx,fy]=this.adjustInputPos(pos);return dx=fx-ix,dy=fy-iy,this.queueAnim(new Anim((prog=>{this.x=ix+dx*prog,this.y=iy+dy*prog}),time,easing),force)}addForce(force,dir,time=1e3,easing=Anim.easeInOutQuad){let rDir=toRad(dir),ix=this.x,iy=this.y,dx=getAcceptableDif(force*Math.cos(rDir),1e-7),dy=getAcceptableDif(force*Math.sin(rDir),1e-7);return this.queueAnim(new Anim((prog=>{this.x=ix+dx*prog,this.y=iy-dy*prog}),time,easing),!0)}queueAnim(anim,force){this.currentAnim&&force&&(this.currentAnim.end(),this._anims.addAt(anim,1));let initEndCB=anim.endCallback;return anim.endCallback=()=>{this._anims.shift(),"function"==typeof initEndCB&&initEndCB()},this._anims.push(anim),anim}adjustInputPos(pos){let[x,y]=pos;return null==x&&(x=this.x),null==y&&(y=this.y),[x,y]}get id(){return this._id}get x(){return this._pos[0]}get y(){return this._pos[1]}get radius(){return this._radius}get top(){return this.y-this._radius}get bottom(){return this.y+this._radius}get right(){return this.x+this._radius}get left(){return this.x-this._radius}get pos(){return this._pos}get pos_(){return[...this._pos]}get stringPos(){return this.x+","+this.y}get initPos(){return this._initPos}get width(){return 2*this._radius}get height(){return 2*this._radius}get currentAnim(){return this._anims[0]}get rgba(){return this._rgba}get r(){return this._rgba[0]}get g(){return this._rgba[1]}get b(){return this._rgba[2]}get a(){return this._rgba[3]}get anims(){return this._anims}get currentAnim(){return this._anims[0]}get setupCB(){return this._setupCB}set x(x){this._pos[0]=x}set y(y){this._pos[1]=y}set pos(pos){this._pos=pos}set radius(radius){this._radius=radius}set r(r){this._rgba[0]=r}set g(g){this._rgba[1]=g}set b(b){this._rgba[2]=b}set a(a){this._rgba[3]=a}set rgba(rgba){this._rgba=rgba}set setupCB(cb){this._setupCB=cb}}class Shape extends Obj{constructor(pos,dots,radius,rgba,limit,drawEffectCB,ratioPosCB,setupCB,fragile){super(pos,radius,rgba,setupCB),this._cvs=null,this._limit=limit||100,this._initDots=dots,this._dots=[],this._ratioPos=[1/0,1/0],this._drawEffectCB=drawEffectCB,this._ratioPosCB=ratioPosCB,this._fragile=fragile||!1,this._rotation=0,this._scale=[1,1]}initialize(){"string"==typeof this._initDots?this.createFromString(this._initDots):"function"==typeof this._initDots?this.add(this._initDots(this,this._cvs)):(this._initDots?.length||this._initDots instanceof Dot)&&this.add(this._initDots),super.initialize(),this._dots.forEach((d=>d.initialize()))}draw(ctx,time){super.draw(ctx,time),"function"==typeof this._ratioPosCB&&(this._ratioPos=this._ratioPosCB(this))}add(dot){this._dots.push(...[dot].flat().map((dot=>(dot.rgba=[...this._rgba],dot.radius??=this._radius,dot.parent=this,dot))))}removeDot(idOrDot){this._dots=this._dots.filter((dot=>dot.id!==(idOrDot?.id??idOrDot)))}remove(){this._cvs.remove(this._id)}createFromString(str,topLeftPos=[0,0],gaps=[25,25],dotChar="o"){let dots=[];return str.split("\n").filter((x=>x)).forEach(((x,i)=>{let[atX,atY]=topLeftPos;atY+=i*gaps[1],[...x].forEach((c=>{c==dotChar&&dots.push(new Dot([atX+gaps[0]/2,atY+gaps[1]/2])),atX+=gaps[0]}))})),dots}setRadius(radius){this._radius=radius,this._dots.forEach((x=>x.radius=radius))}setRGBA(rgba){this._rgba=rgba,this._dots.forEach((x=>x.rgba=rgba))}setLimit(limit){this._limit=limit,this._dots.forEach((x=>x.limit=limit))}addForce(force,dir,time=1e3,easing=Anim.easeInOutQuad){let rDir=toRad(dir),ix=this.x,iy=this.y,dx=getAcceptableDif(force*Math.cos(rDir),1e-7),dy=getAcceptableDif(force*Math.sin(rDir),1e-7);return this.queueAnim(new Anim((prog=>{this.moveAt([ix+dx*prog,iy-dy*prog])}),time,easing),!0)}moveBy(pos){super.moveBy(pos);let d_ll=this._dots.length;for(let i=0;i<d_ll;i++)this._dots[i].moveBy(pos)}moveAt(pos){let[fx,fy]=this.adjustInputPos(pos),dx=fx-this.x,dy=fy-this.y;this._dots.forEach((d=>{dx&&(d.x+=dx),dy&&(d.y+=dy)})),super.moveAt(pos)}moveTo(pos,time=1e3,easing=Anim.easeInOutQuad,force=!0,initPos=this.pos){let[ix,iy]=initPos,dx=pos[0]-ix,dy=pos[1]-iy;return this.queueAnim(new Anim((prog=>{this.moveAt([ix+dx*prog,iy+dy*prog])}),time,easing),force)}rotateBy(deg,centerPos=this.pos){let[cx,cy]=centerPos;this._dots.forEach((dot=>{let x=dot.x-cx,y=dot.y-cy,cosV=Math.cos(toRad(deg)),sinV=Math.sin(toRad(deg));dot.x=x*cosV-y*sinV+cx,dot.y=x*sinV+y*cosV+cy})),this._rotation=(this._rotation+deg)%360}rotateAt(deg,centerPos=this.pos){this.rotateBy(360-(this._rotation-deg),centerPos)}rotateTo(deg,time=1e3,easing=Anim.easeInOutQuad,force=!0,centerPos=this.pos){let ir=this._rotation,dr=deg-this._rotation;return this.queueAnim(new Anim((prog=>{this.rotateAt(ir+dr*prog,centerPos)}),time,easing),force)}scaleBy(scale,centerPos=this.pos){let[scaleX,scaleY]=scale,[cx,cy]=centerPos;this._dots.forEach((dot=>{dot.x=(dot.x-cx)*scaleX+cx,dot.y=(dot.y-cy)*scaleY+cy})),this._scale=[this._scale[0]*scaleX,this._scale[1]*scaleY]}scaleAt(scale,centerPos=this.pos){let dsX=scale[0]/this._scale[0],dsY=scale[1]/this._scale[1];this.scaleBy([dsX,dsY],centerPos)}scaleTo(scale,time=1e3,easing=Anim.easeInOutQuad,force=!0,centerPos=this.pos){let is=this._scale,dsX=scale[0]-this._scale[0],dsY=scale[1]-this._scale[1];return this.queueAnim(new Anim((prog=>{this.scaleAt([is[0]+dsX*prog,is[1]+dsY*prog],centerPos)}),time,easing),force)}clear(){this._dots=[]}reset(){this._initDots&&(this.clear(),this.initialize())}get cvs(){return this._cvs}get ctx(){return this._cvs.ctx}get dots(){return this._dots}get limit(){return this._limit}get initDots(){return this._initDots}get drawEffectCB(){return this._drawEffectCB}get ratioPos(){return this._ratioPos}get ratioPosCB(){return this._ratioPosCB}get rotation(){return this._rotation}get lastDotsPos(){return this._lastDotsPos}get dotsPositions(){let currentDotPos="",d_ll=this.dots.length;for(let i=0;i<d_ll;i++)currentDotPos+=this.dots[i].stringPos;return currentDotPos}get asSource(){return this._dots}static get childrenPath(){return"dots"}set cvs(cvs){this._cvs=cvs}set ratioPos(ratioPos){this._ratioPos=ratioPos}set drawEffectCB(cb){this._drawEffectCB=cb}set ratioPosCB(cb){this._ratioPosCB=cb}set lastDotsPos(ldp){this._lastDotsPos=ldp}}class Gradient{#lastDotsPos=null;#lastRotation=null;constructor(ctx,positions,isLinear=0,...colorStops){this._ctx=ctx,this._isLinear=this.#getFormatedIsLinear(isLinear),this._initPositions=positions,this._positions=this.getAutomaticPositions(),this._colorStops=colorStops.flat(),this._gradient=null,this.updateGradient()}#getFormatedIsLinear(isLinear=this._isLinear){return"number"==typeof isLinear?isLinear:1==isLinear&&0}getAutomaticPositions(shape=this._initPositions,optimize=!0){if(shape instanceof Shape){let currentDotPos=optimize?shape.dotsPositions:null;if(optimize&&this.#lastRotation===this._isLinear&&currentDotPos===this.#lastDotsPos)return this._positions;{this.#lastDotsPos=currentDotPos,this.#lastRotation=this._isLinear;const rangeX=getMinMax(shape.dots,"x"),rangeY=getMinMax(shape.dots,"y"),smallestX=rangeX[0],smallestY=rangeY[0],biggestX=rangeX[1],biggestY=rangeY[1],cx=smallestX+(biggestX-smallestX)/2,cy=smallestY+(biggestY-smallestY)/2;if(!1!==this.#getFormatedIsLinear()){let x=smallestX-cx,y=smallestY-cy,x2=biggestX-cx,y2=biggestY-cy,cosV=Math.cos(toRad(this.#getFormatedIsLinear())),sinV=Math.sin(toRad(this.#getFormatedIsLinear()));return[[x*cosV-y*sinV+cx,x*sinV+y*cosV+cy],[x2*cosV-y2*sinV+cx,x2*sinV+y2*cosV+cy]]}{let coverRadius=Math.max(biggestX-smallestX,biggestY-smallestY);return[[cx,cy,coverRadius],[cx,cy,.25*coverRadius]]}}}return this._positions}updateGradient(){this._positions=this.getAutomaticPositions(),this._gradient=this._ctx[`create${"number"==typeof this.#getFormatedIsLinear()?"Linear":"Radial"}Gradient`](...this._positions[0],...this._positions[1]);let cs_ll=this._colorStops.length;for(let i=0;i<cs_ll;i++)this._gradient.addColorStop(this._colorStops[i][0],formatColor(this._colorStops[i][1]));return this._gradient}get ctx(){return this._ctx}get initPositions(){return this._initPositions}get positions(){return this._positions}get isLinear(){return this._isLinear}get colorStops(){return this._colorStops}get rotation(){return"number"==typeof this.#getFormatedIsLinear()?this._isLinear:null}get gradient(){return this._initPositions instanceof Shape&&this.updateGradient(),this._gradient}set ctx(_ctx){return this._ctx=_ctx}set positions(_positions){return this._positions=_positions}set colorStops(_colorStops){return this._colorStops=_colorStops}set isLinear(isLinear){return this._isLinear=isLinear}set rotation(deg){return this._isLinear="number"==typeof deg?deg%360:this._isLinear}}class FilledShape extends Shape{#lastDotsPos=null;constructor(rgbaFill,dynamicUpdates,pos,dots,radius,rgba,limit,drawEffectCB,ratioPosCB,setupCB,fragile){super(pos,dots,radius,rgba,limit,drawEffectCB,ratioPosCB,setupCB,fragile),this._initRgbaFill=rgbaFill,this._rgbaFill=this._initRgbaFill,this._path=null,this._dynamicUpdates=dynamicUpdates}initialize(){super.initialize(),"function"==typeof this._initRgbaFill&&(this._rgbaFill=this._initRgbaFill(this.ctx,this)),this.updatePath()}draw(ctx,time){super.draw(ctx,time),this.dots.length>2&&(this._dynamicUpdates&&this.updatePath(),ctx.fillStyle=this._rgbaFill.gradient||formatColor(this._rgbaFill),ctx.fill(this._path))}updatePath(){let d_ll=this.dots.length;if(d_ll){let currentDotPos=this.dotsPositions;if(currentDotPos!==this.#lastDotsPos){this.#lastDotsPos=currentDotPos,this._path=new Path2D,this._path.moveTo(...this.dots[0].pos);for(let i=1;i<d_ll;i++)this._path.lineTo(...this.dots[i].pos);this._path.closePath()}}}get rgbaFill(){return this._rgbaFill}get path(){return this._path}get dynamicUpdates(){return this._dynamicUpdates}set rgbaFill(_rgbaFill){return this._rgbaFill=_rgbaFill}set dynamicUpdates(_dynamicUpdates){return this._dynamicUpdates=_dynamicUpdates}}class Grid extends Shape{static DEFAULT_GAPS=[25,25];constructor(keys,gaps,spacing,source,pos,radius,rgba,limit,drawEffectCB,ratioPosCB,setupCB,fragile){super(pos,null,radius,rgba,limit,drawEffectCB,ratioPosCB,setupCB,fragile),this._keys=keys,this._gaps=gaps??Grid.DEFAULT_GAPS,this._source=source??GridAssets.fontSource5x5,this._spacing=spacing??this._source.width*this._gaps[0]+this._gaps[0]-this._source.width+this._radius,this._keys&&super.add(this.createGrid())}createGrid(keys=this._keys,pos=super.pos,gaps=this._gaps,spacing=this._spacing,source=this._source){let[cx,cy]=pos,isNewLine=!0,symbols=[];return[...keys].forEach((l=>{let symbol=this.createSymbol(l,[cx="\n"==l?pos[0]:cx+spacing*!isNewLine,cy+="\n"==l&&source.width*gaps[1]+this.radius]);isNewLine="\n"==l,symbols.push(symbol)})),symbols.flat()}createSymbol(key,pos=super.pos,source=this._source){let dotGroup=[],[gx,gy]=this._gaps,xi=[0,0],yi=0,s=source[key.toUpperCase()],sourceRadius=Math.sqrt(source.width*source.height);return s&&s.map(((d,i)=>[new Dot([pos[0]+(xi[0]=d[0]??xi[0]+1,(isNaN(Math.abs(d[0]))?xi[0]:Math.abs(d[0]))*gx),pos[1]+(yi+=xi[0]<=xi[1]||!i||-1==Math.sign(1/xi[0]))*gy],this.radius,this.rgba),d[1],yi*sourceRadius+(xi[1]=Math.abs(xi[0]))])).forEach((([dot,c,p],_,a)=>{D.places.forEach((dir=>{c&dir[0]&&dot.addConnection(a.find((n=>n[2]==p+dir[1](sourceRadius)))?.[0])})),dotGroup.push(dot)})),dotGroup}setKeys(keys){super.clear(),this._keys=keys,super.add(this.createGrid())}setGaps(gaps){super.clear(),this._gaps=gaps,super.add(this.createGrid())}setSpacing(spacing){super.clear(),this._spacing=spacing,super.add(this.createGrid())}setSource(source){super.clear(),this._source=source,super.add(this.createGrid())}get keys(){return this._keys}get gaps(){return this._gaps}get spacing(){return this._spacing}get source(){return this._source}set keys(keys){return this._keys=keys}set gaps(gaps){return this._gaps=gaps}set spacing(spacing){return this._spacing=spacing}set source(source){return this._source=source}}class Dot extends Obj{constructor(pos,radius,rgba,setupCB){super(pos,radius,rgba,setupCB),this._parent=null,this._connections=[]}draw(ctx,time){if(ctx.fillStyle=formatColor(this._rgba||DEFAULT_RGBA),ctx.beginPath(),ctx.arc(this.x,this.y,this._radius??5,0,CIRC),ctx.fill(),"function"==typeof this.drawEffectCB){let dist=this.getDistance(),rawRatio=this.getRatio(dist);this.drawEffectCB(ctx,this,Math.min(1,rawRatio),this.cvs.mouse,dist,this._parent,rawRatio)}super.draw(ctx,time)}getDistance(fx,fy){return getDist(fx??this.ratioPos[0],fy??this.ratioPos[1],this.x,this.y)}getRatio(dist){return dist/this.limit}addConnection(dot){dot instanceof Dot&&this._connections.push(dot)}removeConnection(dotOrId){this._connections=this._connections.filter((d=>"number"==typeof dotOrId?d.id!==dotOrId:d.id!==dotOrId.id))}follow(duration,easing,action,...progressSeparations){let[ix,iy]=this._pos,ps_ll=progressSeparations.length-1;this.queueAnim(new Anim((prog=>{let progSep=null;prog<0&&(prog=0);for(let i=ps_ll;i>=0;i--){let progressSepIndex=progressSeparations[i];if(progressSepIndex[0]<=prog){progSep=progressSepIndex;break}}const[nx,ny]=progSep[1](prog,prog-progSep[0],this,ix,iy);this.x=ix+nx,this.y=iy+ny,"function"==typeof action&&action(prog,this)}),duration,easing))}remove(){this._parent.removeDot(this._id)}get cvs(){return this._parent?.cvs}get ctx(){return this._parent?.cvs.ctx}get limit(){return this._parent?.limit}get drawEffectCB(){return this._parent?.drawEffectCB}get parent(){return this._parent}get ratioPos(){return this._parent?.ratioPos}get connections(){return this._connections}set limit(limit){this._limit=limit}set parent(p){this._parent=p}set connections(c){return this._connections=c}}